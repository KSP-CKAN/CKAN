#!/bin/sh
set -e

configuration="Debug"
arg0=""
remainingArgs=""

# .net framework not available on macos
if [ "$(uname)" = "Darwin" ]; then
    configuration="Debug_NetCore"
fi

if [ $# -gt 0 ]; then
    configuration="$1"
fi

if [ $# -gt 1 ]; then
    arg0="$2"
fi

if [ $# -gt 2 ]; then
    skippedFirst=false
    for i in "$@"; do
        if $skippedFirst; then
            remainingArgs="$remainingArgs $i"
        else
            skippedFirst=true
        fi
    done
fi

nugetVersion="5.6.0"
useExperimental=false
rootDir=$(dirname $0)
scriptFile="$rootDir/build.cake"
buildDir="$rootDir/_build"
toolsDir="$buildDir/tools"
packagesDir="$buildDir/lib/nuget"
nugetExe="$toolsDir/NuGet/$nugetVersion/nuget.exe"
packagesConfigFile="$rootDir/packages.config"
cakeVersion="$(sed -nE "/id=\"Cake\"/s/.*version=\"(.+)\".*/\1/p" $packagesConfigFile)"
cakeExe="$packagesDir/Cake.$cakeVersion/Cake.exe"

nugetDir="$(dirname $nugetExe)"
if [ ! -d "$nugetDir" ]; then
    mkdir -p "$nugetDir"
fi

if [ ! -f "$nugetExe" ]; then
    curl -L "https://dist.nuget.org/win-x86-commandline/v${nugetVersion}/nuget.exe" --output "$nugetExe"
fi

mono "$nugetExe" restore "$packagesConfigFile" -OutputDirectory "$packagesDir"

cakeArgs=""

if [ -n "$arg0" ]; then
    case $arg0 in
        -*)
            cakeArgs="$cakeArgs $arg0"
            ;;
        *)
            cakeArgs="$cakeArgs --target=$arg0"
            ;;
    esac
fi

if $useExperimental; then
    cakeArgs="$cakeArgs --experimental"
fi

mono "$cakeExe" "$scriptFile" "--configuration=$configuration" $cakeArgs $remainingArgs
exit $?
